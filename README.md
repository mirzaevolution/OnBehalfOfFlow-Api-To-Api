# Azure AD Authentication & Authorization
## On Behalf Of User Flow (calling an api from another api)

In the microservices world, it is common to see apis call different apis either in the same
environment or in different environment. Just like in the topic of this tutorial, i will outline a tiny
sample of working of that case in the area of authentication and authorization using Azure AD MSAL for Web.


![Technical-Architecture](/Assets/2023-04-29_02h39_44.png)

We will have a simple web app that calls an api named api #1 (for example) and this api #1 
will call api #2 as well. If we talk about access_token, if those apis are in same app registration we
won't face a difficulty as we can utilize the same scope(s) inside the access_token generated by 
the calling web app. But, what if api #1 and api #2 are in the different app registrations with
different client ids etc? 
we have 2 solutions for that. 
 - The simplest but less secure, is we can use client credentials inside the 
api #1 to call api #2. This technique will result in non-user based access_token or we can say -> machine to machine
communication. 
- Our solution in this tutorial is to use on behalf of user flow technique where we can use access_token from user itself. 

How does it work ? Just like the diagram above. User will be prompted to login to the web app-Azure Ad. 
After that, in the background the web app will get the access_token for that user with scopes to access api #1. This token
will be maintaned by MSAL for Web so that we don't need to care about refreshing the token if it expires. 
After api #1 validated the previous access_token, to access api #2 (inside api #1), it can't use the same access_token generated in web app.
That's why, api #1 needs to request new access_token for that user using user-assertion with the new scopes to access 
api #2 (this process uses MSAL Library). After that process is finished, we can save that token in any cache storage.

All right, let's build a sample application called **Data Security App**.

This app, will have 2 controllers, Hash controller, and Cryptography (Encrpt/Decrypt) Controller by invoking Api #1 (act as a gateway). The Hash Controller resides purely in 
Api #1 (no need to call Api #2). But, Cryptography Controller in Api #1 just a controller calling Api #2 using Http Client. 
So, when the user needs to call Cryptography Controller, there will be On Behalf Of Flow Process there to generate new access_token for accessing 
the Api #2.

![Data-Security-App-Architecture](/Assets/2023-04-29_02h48_00.png)

Ok, let's configure the Azure AD Portal first by creating 3 app registrations (Web App, Web Api #1 and Web Api #2).

![Azure-AD-Portal](/Assets/2023-04-29_02h50_59.png)

In Azure AD Portal App Registration, i have created 3 app registrations with those names in the picture above.
Let's configure the **Obo.Api.Two (Api #2)** first. You can use whatever names you like in your own Azure AD.

![Obo-Api-Two](/Assets/2023-04-29_02h51_24.png)

In the **Obo.Api.Two (Api #2)**, please take a note on *Client Id* and *Tenant Id* to be used in appsettings for Obo.Api.Two.

Now, go to **Expose an Api** menu. In there, you can create a scope like mine. 

![Obo-Api-Two-Scope1](/Assets/2023-04-29_02h52_13.png)

![Obo-Api-Two-Scope2](/Assets/2023-04-29_02h53_18.png)

I created a scope with name Obo.Api.Two for it. You can create any name you like.

After that, we can add authorized client appplications (optional). This will be your Api #1 as it will call the Api #2.
Just click Add a Client Application button and add Client Id of Api #1 (Obo.Api.One in mine) and select the scope you have created.

![Obo-Api-Two-Scope2](/Assets/2023-04-29_02h54_14.png)



All right, we have configured the **Obo.Api.Two**, now let's configure the **Obo.Api.One**.

![Obo-Api-One](/Assets/2023-04-29_02h55_19.png)

Take a note both *Client Id* and *Tenant Id* of it for later use. And now, we can navigate to **Certificate and Secrets** menu.
In this menu, you should generate a secret to be used to call Api #2 (**Obo.Api.Two**). Don't forget to copy the value after generating it.

![Obo-Api-One-Secret](/Assets/2023-04-29_02h56_05.png)

![Obo-Api-One-Secret](/Assets/2023-04-29_02h56_29.png)

Now, let's jump to **Api Permissions** menu to add the permission for **Obo.Api.Two** scope that we have created earlier.

![Obo-Api-One-Permission](/Assets/2023-04-29_02h56_51.png)

You can hit the Add Permission button > My Apis Tab > Select Obo.Api.Two scope and add it. Don't forget to hit **Grant admin consent for default directory** button.

![Obo-Api-One-Permission](/Assets/2023-04-29_02h57_25.png)






