# Azure AD Authentication & Authorization
## On Behalf Of User Flow (calling an api from another api)

In the microservices world, it is common to see apis call different apis either in the same
environment or in different environment. Just like in the topic of this tutorial, i will outline a tiny
sample of working of that case in the area of authentication and authorization using Azure AD MSAL for Web.


![Technical-Architecture](/Assets/2023-04-29_02h39_44.png)

We will have a simple web app that calls an api named api #1 (for example) and this api #1 
will call api #2 as well. If we talk about access_token, if those apis are in same app registration we
won't face a difficulty as we can utilize the same scope(s) inside the access_token generated by 
the calling web app. But, what if api #1 and api #2 are in the different app registrations with
different client ids etc? 
we have 2 solutions for that. 
 - The simplest but less secure, is we can use client credentials inside the 
api #1 to call api #2. This technique will result in non-user based access_token or we can say -> machine to machine
communication. 
- Our solution in this tutorial is to use on behalf of user flow technique where we can use access_token from user itself. 

How does it work ? Just like the diagram above. User will be prompted to login to the web app-Azure Ad. 
After that, in the background the web app will get the access_token for that user with scopes to access api #1. This token
will be maintaned by MSAL for Web so that we don't need to care about refreshing the token if it expires. 
After api #1 validated the previous access_token, to access api #2 (inside api #1), it can't use the same access_token generated in web app.
That's why, api #1 needs to request new access_token for that user using user-assertion with the new scopes to access 
api #2 (this process uses MSAL Library). After that process is finished, we can save that token in any cache storage.

All right, let's build a sample application called **Data Security App**.

This app, will have 2 controllers, Hash controller, and Cryptography (Encrpt/Decrypt) Controller by invoking Api #1 (act as a gateway). The Hash Controller resides purely in 
Api #1 (no need to call Api #2). But, Cryptography Controller in Api #1 just a controller calling Api #2 using Http Client. 
So, when the user needs to call Cryptography Controller, there will be On Behalf Of Flow Process there to generate new access_token for accessing 
the Api #2.

![Technical-Architecture](/Assets/2023-04-29_02h48_00.png)
